{% extends 'base.html' %}

{% block title %}{{ profile_user.username }} - Profile{% endblock %}

{% block content %}
<style>
    .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
    }
    
    .profile-pic-large {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .profile-info {
        flex: 1;
    }
    
    .profile-stats {
        display: flex;
        gap: 30px;
        margin-bottom: 15px;
    }
    
    .stat-item {
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .stat-item:hover {
        color: #1877f2;
    }
    
    .profile-actions {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    
    .btn-message {
        background: #42b72a;
        color: white;
    }
    
    .btn-block {
        background: #dc3545;
        color: white;
    }
    
    /* Edit Profile Button Container */
    .name-edit-container {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 5px;
        flex-wrap: wrap;
    }
    
    .name-edit-container h2 {
        margin: 0;
    }
    
    .edit-profile-btn-small {
        background: #f0f2f5;
        color: #050505;
        border: 1px solid #ddd;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
    }
    
    .edit-profile-btn-small:hover {
        background: #e4e6eb;
        text-decoration: none;
        color: #050505;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        width: 90%;
        max-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        animation: modalFadeIn 0.3s;
    }
    
    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
    }
    
    .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }
    
    .close-modal:hover {
        background-color: #f0f2f5;
    }
    
    .modal-body {
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .user-list-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #eee;
        text-decoration: none;
        color: inherit;
        transition: background-color 0.2s;
    }
    
    .user-list-item:hover {
        background-color: #f8f9fa;
        text-decoration: none;
        color: inherit;
    }
    
    .user-list-item:last-child {
        border-bottom: none;
    }
    
    .user-list-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 12px;
    }
    
    .user-list-info {
        flex: 1;
    }
    
    .user-list-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
    }
    
    .user-list-username {
        font-size: 12px;
        color: #65676b;
    }
    
    .no-users-message {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }
    
    .no-users-icon {
        font-size: 32px;
        margin-bottom: 10px;
        opacity: 0.5;
    }
    
    /* Posts grid styling (keep existing styles) */
    .posts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 30px;
    }
    
    .post-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        border: 1px solid #ddd;
        overflow: hidden;
    }
    
    .post-header {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
    }
    
    .post-header-info {
        flex: 1;
    }
    
    .post-header-info strong {
        display: block;
        font-size: 14px;
    }
    
    .post-header-info .post-time {
        font-size: 12px;
        color: #65676b;
    }
    
    .post-content {
        padding: 15px;
        line-height: 1.5;
        font-size: 14px;
        position: relative;
    }
    
    .post-actions {
        padding: 10px 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 20px;
    }
    
    .post-action {
        cursor: pointer;
        color: #65676b;
        font-size: 14px;
        transition: color 0.2s;
    }
    
    .post-action:hover {
        color: #1877f2;
    }
    
    .comment-section {
        padding: 15px;
        border-top: 1px solid #eee;
        background: #f8f9fa;
    }
    
    .comment-input-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .comment-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
        background: white;
    }
    
    .comment-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .comment-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .comment-item:last-child {
        border-bottom: none;
    }
    
    .comment-user-pic {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }
    
    .comment-content {
        flex: 1;
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .comment-user {
        font-weight: bold;
        font-size: 13px;
        color: #1877f2;
    }
    
    .comment-time {
        font-size: 11px;
        color: #999;
    }
    
    .comment-text {
        font-size: 13px;
        line-height: 1.4;
        color: #333;
    }
    
    .no-posts {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }
    
    .no-posts-icon {
        font-size: 48px;
        margin-bottom: 15px;
        color: #ddd;
    }
    
    /* SIMPLIFIED Edit/Delete Styles */
    .post-edit-options {
        display: flex;
        gap: 10px;
    }
    
    .edit-post-btn {
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .edit-post-form {
        display: none;
        margin-top: 15px;
    }
    
    .edit-post-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 10px;
        resize: vertical;
    }
    
    .edit-post-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .save-edit-btn {
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .cancel-edit-btn {
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
    }
    
 

    .comment-input-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.comment-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 14px;
    background: white;
    outline: none;
    transition: border-color 0.2s;
}

.comment-input:focus {
    border-color: #1877f2;
}

.comment-send-btn {
    background: #1877f2;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
}
/* Custom Confirmation Modal Styles */
.confirmation-modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.confirmation-content {
    background-color: white;
    margin: 20% auto;
    padding: 0;
    width: 90%;
    max-width: 400px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: modalFadeIn 0.3s;
    overflow: hidden;
}

.confirmation-header {
    padding: 20px;
    border-bottom: 1px solid #e4e6eb;
    text-align: center;
}

/* Responsive design */
@media (max-width: 768px) {
    .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .profile-actions {
        justify-content: center;
    }
    
    .profile-stats {
        justify-content: center;
    }
    
    .modal-content {
        margin: 10% auto;
        width: 95%;
    }
    
    .name-edit-container {
        justify-content: center;
        text-align: center;
        gap: 10px;
    }
    
    .name-edit-container h2 {
        width: 100%;
        margin-bottom: 5px;
    }
    
    /* Fix confirmation modal position on mobile */
    .confirmation-content {
        margin: 40% auto 20px auto; /* Changed from 20% to 40% auto 20px auto */
        width: 90%;
        max-width: 350px;
    }
}

.confirmation-header h3 {
    margin: 0;
    font-size: 18px;
    color: #1c1e21;
}

.confirmation-body {
    padding: 20px;
    text-align: center;
    color: #65676b;
    font-size: 15px;
    line-height: 1.5;
}

.confirmation-actions {
    display: flex;
    padding: 16px 20px;
    border-top: 1px solid #e4e6eb;
    gap: 10px;
}

.confirmation-btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.confirmation-btn-cancel {
    background: #f0f2f5;
    color: #1c1e21;
}

.confirmation-btn-cancel:hover {
    background: #e4e6eb;
}

.confirmation-btn-delete {
    background: #dc3545;
    color: white;
}

.confirmation-btn-delete:hover {
    background: #c82333;
}
.comment-send-btn:hover {
    background: #166fe5;
}

.comment-send-btn svg {
    width: 18px;
    height: 18px;
}
</style>

<!-- Followers Modal -->
<div id="followersModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Followers</h3>
            <button class="close-modal" onclick="closeModal('followersModal')">&times;</button>
        </div>
        <div class="modal-body" id="followersList">
            <!-- Followers will be loaded here -->
        </div>
    </div>
</div>

<!-- Following Modal -->
<div id="followingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Following</h3>
            <button class="close-modal" onclick="closeModal('followingModal')">&times;</button>
        </div>
        <div class="modal-body" id="followingList">
            <!-- Following will be loaded here -->
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmationModal" class="confirmation-modal">
    <div class="confirmation-content">
        <div class="confirmation-header">
            <h3>Delete Post</h3>
        </div>
        <div class="confirmation-body" id="confirmationMessage">
            Are you sure you want to delete this post?
        </div>
        <div class="confirmation-actions">
            <button class="confirmation-btn confirmation-btn-cancel" onclick="cancelDelete()">Cancel</button>
            <button class="confirmation-btn confirmation-btn-delete" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<div class="main-content">
    <!-- Profile Header -->
    <div class="card">
        <div class="profile-header">
            <div>
                <img src="{% if profile_user.profile.profile_pic %}{{ profile_user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/150{% endif %}" 
                     class="profile-pic-large" 
                     alt="{{ profile_user.username }}'s profile picture">
            </div>
            
            <div class="profile-info">
              
                <div class="name-edit-container">
                    <h2>
                        {% if profile_user.get_full_name %}{{ profile_user.get_full_name }}{% else %}{{ profile_user.username }}{% endif %}
                    </h2>
                    
                    {% if user == profile_user %}
                        <a href="{% url 'edit_profile' %}" class="edit-profile-btn-small">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path>
                            </svg>
                            Edit Profile
                        </a>
                    {% endif %}
                </div>
                
                <!-- Username -->
                <p style="color: #65676b; font-style: italic; margin: 0 0 15px 0;">
                    @{{ profile_user.username }}
                </p>
                
                <!-- Follow/Message/Block buttons (for other users) -->
                <div class="profile-actions">
                    {% if user != profile_user %}
                        <button type="button" onclick="followUser('{{ profile_user.username }}')" class="btn" id="followBtn">
                            {% if is_following %}Unfollow{% else %}Follow{% endif %}
                        </button>
                        
                        <button type="button" onclick="openMessageBox('{{ profile_user.username }}')" class="btn btn-message">
                            Message
                        </button>
                        
                        <!-- <button type="button" onclick="blockUser('{{ profile_user.username }}')" class="btn btn-block">
                            Block
                        </button> -->
                    {% endif %}
                </div>
                
                <!-- Profile stats -->
                <div class="profile-stats">
                    <div>
                        <strong>{{ posts.count }}</strong> posts
                    </div>
                    <div class="stat-item" onclick="showFollowers('{{ profile_user.username }}')">
                        <strong>{{ follower_count }}</strong> followers
                    </div>
                    <div class="stat-item" onclick="showFollowing('{{ profile_user.username }}')">
                        <strong>{{ following_count }}</strong> following
                    </div>
                </div>
                
                <!-- Bio -->
                <div>
                    <p>{{ profile_user.profile.bio|default:"No bio yet" }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User's Posts -->
    <div class="posts-grid">
        {% if posts %}
            {% for post in posts %}
            <div class="post-container" id="post-{{ post.id }}">
                <!-- Post Header -->
                <div class="post-header">
                    <img src="{% if post.user.profile.profile_pic %}{{ post.user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/40{% endif %}" 
                         class="profile-pic" 
                         alt="{{ post.user.username }}'s profile picture">
                    <div class="post-header-info">
                        <strong>{{ post.user.username }}</strong>
                        <div class="post-time">
    {{ post.created_at|timesince }} ago
    {% if post.is_edited %}  <!-- This will always be False -->
        <span style="color: #666; font-size: 11px;">(edited)</span>
    {% endif %}
</div>
                    </div>
                    
                    {% if user == profile_user %}
                    <div class="post-edit-options">
                        <button class="edit-post-btn" onclick="editPost({{ post.id }})">
                            Edit
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Post Content Display -->
                <div class="post-content" id="postContent-{{ post.id }}">
                    {{ post.content|linebreaks }}
                </div>
                
                <!-- Edit Post Form (Hidden by default) -->
                <div class="edit-post-form" id="editForm-{{ post.id }}">
                    <textarea class="edit-post-textarea" id="editTextarea-{{ post.id }}">{{ post.content }}</textarea>
                    <div class="edit-post-buttons">
                        <button class="cancel-edit-btn" onclick="cancelEdit({{ post.id }})">Cancel</button>
                        <button class="save-edit-btn" onclick="saveEdit({{ post.id }})">Save</button>
                    </div>
                </div>
                
                <!-- Post Actions -->
                <div class="post-actions">
                    <span class="post-action" onclick="likePost({{ post.id }})">
                        <span id="likeText-{{ post.id }}">Like</span>
                        (<span id="likeCount-{{ post.id }}">{{ post.like_count }}</span>)
                    </span>
                    
                    <span class="post-action" onclick="toggleComment({{ post.id }})">
                        Comment (<span id="commentCount-{{ post.id }}">{{ post.comment_count_value }}</span>)
                    </span>
                    
                    {% if user == profile_user %}
<span class="post-action" onclick="deletePost({{ post.id }})" style="color: #dc3545;">
    Delete
</span>
{% endif %}
                </div>
                
                <!-- Comments Section -->
                <div id="comments-{{ post.id }}" class="comment-section" style="display: none;">
                    <!-- Comment Input -->
                    <!-- Comment Input with Send Button -->
<div class="comment-input-container">
    <input type="text" id="commentInput-{{ post.id }}" class="comment-input" 
           placeholder="Write a comment..." 
           onkeypress="if(event.key === 'Enter') addComment({{ post.id }})">
    <button onclick="addComment({{ post.id }})" class="comment-send-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
        </svg>
    </button>
</div>
                    
                    <!-- Comments List -->
                    <div class="comment-list" id="commentList-{{ post.id }}">
                        <!-- Comments will be loaded here -->
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="card no-posts">
                <div class="no-posts-icon">üìù</div>
                <p>
                    {% if user == profile_user %}
                        You haven't created any posts yet.
                    {% else %}
                        {{ profile_user.username }} hasn't created any posts yet.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    // Modal Functions
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
    }


    // Variables for post deletion
let currentPostIdToDelete = null;

// Show custom confirmation modal
function deletePost(postId) {
    currentPostIdToDelete = postId;
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmationMessage = document.getElementById('confirmationMessage');
    
    // Customize the message if needed
    confirmationMessage.textContent = "Are you sure you want to delete this post?";
    
    // Show the modal
    confirmationModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// Confirm deletion
function confirmDelete() {
    if (currentPostIdToDelete) {
        performDelete(currentPostIdToDelete);
    }
    closeConfirmation();
}

// Cancel deletion
function cancelDelete() {
    closeConfirmation();
}

document.addEventListener('DOMContentLoaded', function() {
    // ... your existing initialization code ...
    
    // Add Enter key support for confirmation modal
    document.addEventListener('keydown', function(event) {
        // Only handle if confirmation modal is open
        const confirmationModal = document.getElementById('confirmationModal');
        if (confirmationModal && confirmationModal.style.display === 'block') {
            if (event.key === 'Enter') {
                event.preventDefault();
                confirmDelete();
            }
        }
    });
    
    // ... rest of your initialization code ...
});

// Close confirmation modal
function closeConfirmation() {
    const confirmationModal = document.getElementById('confirmationModal');
    confirmationModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    currentPostIdToDelete = null;
}

// Actual delete function
function performDelete(postId) {
    fetch('/delete-post/' + postId + '/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const postElement = document.getElementById('post-' + postId);
            if (postElement) {
                // Add fade out animation
                postElement.style.transition = 'opacity 0.3s, transform 0.3s';
                postElement.style.opacity = '0';
                postElement.style.transform = 'translateY(-10px)';
                
                // Remove after animation
                setTimeout(() => {
                    if (postElement.parentNode) {
                        postElement.remove();
                    }
                    
                    // Check if no posts left
                    const postsGrid = document.querySelector('.posts-grid');
                    if (postsGrid && postsGrid.children.length === 0) {
                        postsGrid.innerHTML = `
                            <div class="card no-posts">
                                <div class="no-posts-icon">üìù</div>
                                <p>
                                    {% if user == profile_user %}
                                        You haven't created any posts yet.
                                    {% else %}
                                        {{ profile_user.username }} hasn't created any posts yet.
                                    {% endif %}
                                </p>
                            </div>
                        `;
                    }
                }, 300);
            }
        } else {
            alert('Failed to delete post. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting post. Please try again.');
    });
}

// Add this to your existing keydown event listener
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        // Close any open modals including confirmation
        const openModals = document.querySelectorAll('.modal[style*="display: block"], .confirmation-modal[style*="display: block"]');
        openModals.forEach(modal => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
        
        // Cancel edit forms
        const editForms = document.querySelectorAll('.edit-post-form[style*="display: block"]');
        editForms.forEach(form => {
            const postId = form.id.replace('editForm-', '');
            cancelEdit(postId);
        });
    }
});
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Re-enable scrolling
        }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Show Followers
    function showFollowers(username) {
        const modal = document.getElementById('followersModal');
        const listContainer = document.getElementById('followersList');
        
        // Show loading
        listContainer.innerHTML = `
            <div class="no-users-message">
                <div class="no-users-icon">‚è≥</div>
                <p>Loading followers...</p>
            </div>
        `;
        
        openModal('followersModal');
        
        // Fetch followers data
        fetch(`/api/followers/${username}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch followers');
                }
                return response.json();
            })
            .then(data => {
                listContainer.innerHTML = '';
                
                if (data.followers.length === 0) {
                    listContainer.innerHTML = `
                        <div class="no-users-message">
                            <div class="no-users-icon">üë§</div>
                            <p>No followers yet</p>
                        </div>
                    `;
                    return;
                }
                
                data.followers.forEach(follower => {
                    const userItem = document.createElement('a');
                    userItem.className = 'user-list-item';
                    userItem.href = `/profile/${follower.username}/`;
                    
                    const profilePicUrl = follower.profile_pic || 'https://via.placeholder.com/40';
                    
                    userItem.innerHTML = `
                        <img src="${profilePicUrl}" class="user-list-pic">
                        <div class="user-list-info">
                            <div class="user-list-name">
                                ${follower.full_name || follower.username}
                            </div>
                            <div class="user-list-username">@${follower.username}</div>
                        </div>
                    `;
                    
                    listContainer.appendChild(userItem);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                listContainer.innerHTML = `
                    <div class="no-users-message">
                        <div class="no-users-icon">‚ö†Ô∏è</div>
                        <p>Failed to load followers</p>
                        <p style="font-size: 12px; margin-top: 5px;">Please try again</p>
                    </div>
                `;
            });
    }
    
    // Show Following
    function showFollowing(username) {
        const modal = document.getElementById('followingModal');
        const listContainer = document.getElementById('followingList');
        
        // Show loading
        listContainer.innerHTML = `
            <div class="no-users-message">
                <div class="no-users-icon">‚è≥</div>
                <p>Loading following...</p>
            </div>
        `;
        
        openModal('followingModal');
        
        // Fetch following data
        fetch(`/api/following/${username}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch following');
                }
                return response.json();
            })
            .then(data => {
                listContainer.innerHTML = '';
                
                if (data.following.length === 0) {
                    listContainer.innerHTML = `
                        <div class="no-users-message">
                            <div class="no-users-icon">üë§</div>
                            <p>Not following anyone yet</p>
                        </div>
                    `;
                    return;
                }
                
                data.following.forEach(following => {
                    const userItem = document.createElement('a');
                    userItem.className = 'user-list-item';
                    userItem.href = `/profile/${following.username}/`;
                    
                    const profilePicUrl = following.profile_pic || 'https://via.placeholder.com/40';
                    
                    userItem.innerHTML = `
                        <img src="${profilePicUrl}" class="user-list-pic">
                        <div class="user-list-info">
                            <div class="user-list-name">
                                ${following.full_name || following.username}
                            </div>
                            <div class="user-list-username">@${following.username}</div>
                        </div>
                    `;
                    
                    listContainer.appendChild(userItem);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                listContainer.innerHTML = `
                    <div class="no-users-message">
                        <div class="no-users-icon">‚ö†Ô∏è</div>
                        <p>Failed to load following</p>
                        <p style="font-size: 12px; margin-top: 5px;">Please try again</p>
                    </div>
                `;
            });
    }
    
    // Follow/Unfollow User
    function followUser(username) {
        fetch('/follow/' + username + '/')
            .then(response => response.json())
            .then(data => {
                const btn = document.getElementById('followBtn');
                if (data.followed) {
                    btn.textContent = 'Unfollow';
                } else {
                    btn.textContent = 'Follow';
                }
                location.reload();
            });
    }
    
    // Block User (to be implemented)
    // function blockUser(username) {
    //     if (confirm('Are you sure you want to block ' + username + '?')) {
    //         alert('Block feature will be implemented');
    //     }
    // }
    
    // Delete Post
   
    
    // Edit Post - Show edit form
    function editPost(postId) {
        const postContent = document.getElementById('postContent-' + postId);
        const editForm = document.getElementById('editForm-' + postId);
        const editTextarea = document.getElementById('editTextarea-' + postId);
        
        if (postContent && editForm) {
            postContent.style.display = 'none';
            editForm.style.display = 'block';
            editTextarea.focus();
            editTextarea.selectionStart = editTextarea.value.length;
        }
    }
    
    // Cancel Edit
    function cancelEdit(postId) {
        const postContent = document.getElementById('postContent-' + postId);
        const editForm = document.getElementById('editForm-' + postId);
        
        if (postContent && editForm) {
            postContent.style.display = 'block';
            editForm.style.display = 'none';
        }
    }
    
    // Save Edit
    function saveEdit(postId) {
        const editTextarea = document.getElementById('editTextarea-' + postId);
        const postContent = document.getElementById('postContent-' + postId);
        const editForm = document.getElementById('editForm-' + postId);
        
        if (!editTextarea) return;
        
        const newContent = editTextarea.value.trim();
        
        if (!newContent) {
            alert('Post content cannot be empty!');
            editTextarea.focus();
            return;
        }
        
        // Show loading
        const saveBtn = editForm.querySelector('.save-edit-btn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;
        
        // Send update
        fetch('/edit-post/' + postId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'content=' + encodeURIComponent(newContent)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                postContent.innerHTML = data.content.replace(/\n/g, '<br>');
                
                // Show edit indicator
                const postTime = document.querySelector(`#post-${postId} .post-time`);
                if (postTime && !postTime.innerHTML.includes('(edited)')) {
                    postTime.innerHTML += ' <span style="color: #666; font-size: 11px;">(edited)</span>';
                }
                
                postContent.style.display = 'block';
                editForm.style.display = 'none';
            } else {
                alert('Failed to update post: ' + (data.error || 'Unknown error'));
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating post. Please try again.');
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        });
    }
    
    // Like Post
    function likePost(postId) {
        fetch('/like/' + postId + '/')
            .then(response => response.json())
            .then(data => {
                const likeText = document.getElementById('likeText-' + postId);
                const likeCount = document.getElementById('likeCount-' + postId);
                
                if (data.liked) {
                    likeText.textContent = 'Unlike';
                } else {
                    likeText.textContent = 'Like';
                }
                
                if (likeCount) {
                    likeCount.textContent = data.count;
                }
            });
    }
    
    // Toggle Comments
    function toggleComment(postId) {
        const commentSection = document.getElementById('comments-' + postId);
        if (commentSection) {
            if (commentSection.style.display === 'none' || commentSection.style.display === '') {
                commentSection.style.display = 'block';
                loadComments(postId);
            } else {
                commentSection.style.display = 'none';
            }
        }
    }
    
    // Add Comment
    function addComment(postId) {
        const input = document.getElementById('commentInput-' + postId);
        if (!input) return;
        
        const content = input.value.trim();
        
        if (content) {
            fetch('/comment/' + postId + '/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'content=' + encodeURIComponent(content)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    addCommentToUI(postId, data.comment);
                    updateCommentCount(postId);
                }
            });
        }
    }
    
    // Load Comments
    function loadComments(postId) {
        const commentList = document.getElementById('commentList-' + postId);
        if (!commentList) return;
        
        commentList.innerHTML = '<p style="padding: 10px; text-align: center; color: #666;">Loading comments...</p>';
        
        fetch('/get-comments/' + postId + '/')
            .then(response => response.json())
            .then(data => {
                commentList.innerHTML = '';
                
                if (data.comments.length === 0) {
                    commentList.innerHTML = '<p style="padding: 10px; text-align: center; color: #666;">No comments yet. Be the first to comment!</p>';
                    return;
                }
                
                data.comments.forEach(comment => {
                    addCommentToUI(postId, comment, false);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                commentList.innerHTML = '<p style="padding: 10px; text-align: center; color: red;">Error loading comments</p>';
            });
    }
    
    // Add Comment to UI
    function addCommentToUI(postId, comment, scrollToBottom = true) {
        const commentList = document.getElementById('commentList-' + postId);
        if (!commentList) return;
        
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment-item';
        
        const profilePicUrl = comment.profile_pic || 'https://via.placeholder.com/32';
        
        commentDiv.innerHTML = `
            <img src="${profilePicUrl}" class="comment-user-pic">
            <div class="comment-content">
                <div class="comment-header">
                    <span class="comment-user">${comment.user}</span>
                    <span class="comment-time">${comment.created_at}</span>
                </div>
                <div class="comment-text">${comment.content}</div>
            </div>
        `;
        
        commentList.appendChild(commentDiv);
        
        if (scrollToBottom) {
            commentList.scrollTop = commentList.scrollHeight;
        }
    }
    
    // Update comment count
    function updateCommentCount(postId) {
        const commentCount = document.getElementById('commentCount-' + postId);
        if (commentCount) {
            fetch('/get-comments/' + postId + '/')
                .then(response => response.json())
                .then(data => {
                    commentCount.textContent = data.comments.length;
                });
        }
    }
    
    // Message user function (opens chat)
    function openMessageBox(username) {
        // Store the username to open in session storage
        sessionStorage.setItem('openChatWith', username);
        // Redirect to messages page
        window.location.href = "{% url 'messages' %}";
    }
    
    // Initialize comment counts
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[id^="commentCount-"]').forEach(element => {
            const postId = element.id.replace('commentCount-', '');
            updateCommentCount(postId);
        });
        
        // Escape to cancel edit and close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // Close any open modals
                const openModals = document.querySelectorAll('.modal[style*="display: block"]');
                openModals.forEach(modal => {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
                
                // Cancel edit forms
                const editForms = document.querySelectorAll('.edit-post-form[style*="display: block"]');
                editForms.forEach(form => {
                    const postId = form.id.replace('editForm-', '');
                    cancelEdit(postId);
                });
            }
        });
        
        // Add hover effects to stat items
        document.querySelectorAll('.stat-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-1px)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
    
    // Get CSRF token helper function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}