{% extends 'base.html' %}

{% block title %}Home - Nepixo{% endblock %}

{% block content %}
{% if user.is_authenticated %}
<!-- Content for LOGGED IN users -->


<div class="main-content">
    <!-- Create Post -->
    <div class="card">
        <h3>What's on your mind?</h3>
        <div class="form-group">
            <textarea id="postContent" class="form-control" rows="3" placeholder="Share your thoughts..."></textarea>
        </div>
        <button onclick="createPost()" class="btn">Post</button>
    </div>
    
    <!-- News Feed -->
    <div id="postsContainer">
        {% for post in posts %}
        <div class="card post" id="post-{{ post.id }}">
            <div class="post-header">
                <!-- Profile picture is now clickable -->
                <a href="{% url 'profile' post.user.username %}" style="text-decoration: none;">
                    <img src="{% if post.user.profile.profile_pic %}{{ post.user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/40{% endif %}" 
                         class="profile-pic" alt="{{ post.user.username }}"
                         style="cursor: pointer;">
                </a>
                <div>
                    <!-- Username is already clickable -->
                    <strong><a href="{% url 'profile' post.user.username %}" style="text-decoration: none; color: inherit;">{{ post.user.username }}</a></strong>
                    <div style="font-size: 12px; color: #65676b;">
                        {{ post.created_at|timesince }} ago
                    </div>
                </div>
            </div>
            
            <div class="post-content">
                {{ post.content|linebreaks }}
            </div>
            
            <div class="post-actions">
    <!-- Like Button -->
    <span class="post-action" onclick="likePost({{ post.id }})" title="Like">
        <i id="likeIcon-{{ post.id }}" class="like-icon {% if post.is_liked_by_user %}fas fa-heart liked{% else %}far fa-heart{% endif %}"></i>
        <span class="post-action-text" id="likeText-{{ post.id }}">
            {% if post.is_liked_by_user %}Liked{% else %}Like{% endif %}
        </span>
        {% if post.like_count > 0 %}
        <span class="post-action-count" id="likeCount-{{ post.id }}">{{ post.like_count }}</span>
        {% endif %}
    </span>
    
    <!-- Comment Button -->
    <span class="post-action" onclick="toggleComment({{ post.id }})" title="Comment">
        <i class="far fa-comment comment-icon"></i>
        <span class="post-action-text">Comment</span>
        {% if post.comment_count > 0 %}
        <span class="post-action-count" id="commentCount-{{ post.id }}">{{ post.comment_count }}</span>
        {% endif %}
    </span>
    
    <!-- Share Button -->
    <span class="post-action" onclick="sharePost({{ post.id }})" title="Share">
        <i class="far fa-share-square share-icon"></i>
        <span class="post-action-text">Share</span>
        {% if post.share_count > 0 %}
        <span class="post-action-count" id="shareCount-{{ post.id }}">{{ post.share_count|default:0 }}</span>
        {% endif %}
    </span>
</div>
            
            <!-- Comments Section -->
           <!-- Comments Section - Mobile Friendly -->
<div id="comments-{{ post.id }}" style="display: none; margin-top: 15px;">
    <div class="comment-form" style="margin-bottom: 15px;">
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <!-- User profile picture -->
            <img src="{% if user.profile.profile_pic %}{{ user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/30{% endif %}" 
                 style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; margin-top: 5px;"
                 alt="{{ user.username }}">
            
            <!-- Comment input area -->
            <div style="flex: 1;">
                <div style="position: relative;">
                    <input type="text" 
                           id="commentInput-{{ post.id }}" 
                           class="form-control" 
                           placeholder="Write a comment..."
                           onkeypress="if(event.key === 'Enter') addComment({{ post.id }})"
                           style="padding-right: 60px; border-radius: 20px; padding-left: 15px;">
                    
                    <!-- Submit button -->
                    <button onclick="addComment({{ post.id }})" 
                            id="commentBtn-{{ post.id }}"
                            style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); 
                                   background: #1877f2; color: white; border: none; border-radius: 50%; 
                                   width: 35px; height: 35px; cursor: pointer; display: flex; 
                                   align-items: center; justify-content: center; transition: all 0.2s;"
                            onmouseover="this.style.backgroundColor='#166fe5'"
                            onmouseout="this.style.backgroundColor='#1877f2'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Alternative: Textarea with larger submit button -->
                <!-- Uncomment below if you want a textarea instead -->
                <!--
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <textarea id="commentInput-{{ post.id }}" 
                              class="form-control" 
                              placeholder="Write a comment..."
                              rows="2"
                              style="border-radius: 10px; resize: vertical; flex: 1;"></textarea>
                    <button onclick="addComment({{ post.id }})" 
                            class="btn" 
                            style="align-self: flex-end; padding: 10px 15px; min-width: 80px;">
                        Post
                    </button>
                </div>
                -->
            </div>
        </div>
        
        <!-- Mobile hint -->
        <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center; display: none;" 
             id="mobileHint-{{ post.id }}">
            Press Enter or tap the send button ‚Üí
        </div>
    </div>
    
    <div id="commentList-{{ post.id }}">
        <!-- Comments will be loaded here -->
    </div>
</div>
        </div>
        {% empty %}
        <div class="card">
            <p>No posts yet. Follow some users or create your first post!</p>
        </div>
        {% endfor %}
    </div>
</div>

<div class="sidebar">
    <!-- User Info -->
    <div class="card">
        <div style="text-align: center;">
            <!-- Make user's own profile picture clickable too -->
            <a href="{% url 'profile' user.username %}" style="text-decoration: none;">
                <img src="{% if user.profile.profile_pic %}{{ user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/100{% endif %}" 
                     style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; cursor: pointer;">
            </a>
            <h3>
                <a href="{% url 'profile' user.username %}" style="text-decoration: none; color: inherit;">{{ user.username }}</a>
            </h3>
            <p style="color: #65676b;">{{ user.profile.bio|default:"No bio yet" }}</p>
            <p>
                <strong>{{ follower_count }}</strong> Followers ‚Ä¢ 
                <strong>{{ following_count }}</strong> Following
            </p>
        </div>
    </div>
    
    <!-- Who to Follow -->
   <!-- Who to Follow -->
<div class="card">
    <h4>Suggestions for you</h4>
    {% for suggested_user in suggestions %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 8px; border-bottom: 1px solid var(--border-color);">
        <div>
            <!-- Make suggested user's profile picture clickable -->
            <a href="{% url 'profile' suggested_user.username %}" style="text-decoration: none; display: flex; align-items: center; gap: 10px;">
                <img src="{% if suggested_user.profile.profile_pic %}{{ suggested_user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/30{% endif %}" 
                     style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                <div>
                    <strong style="color: inherit; font-size: 14px; display: block;">
                        <!-- Show full name if available, otherwise show username -->
                        {% if suggested_user.first_name or suggested_user.last_name %}
                            {{ suggested_user.first_name }} {{ suggested_user.last_name }}
                        {% else %}
                            {{ suggested_user.username }}
                        {% endif %}
                    </strong>
                    <small style="color: #65676b; font-size: 12px;">@{{ suggested_user.username }}</small>
                </div>
            </a>
        </div>
        <button onclick="followUser('{{ suggested_user.username }}')" class="btn" style="padding: 5px 10px; font-size: 12px;">
            Follow
        </button>
    </div>
    {% empty %}
    <p style="text-align: center; color: #65676b; padding: 20px;">No suggestions available</p>
    {% endfor %}
</div>

{% else %}
<!-- Content for NON-LOGGED IN users (Landing Page) -->
<div class="main-content">
    <div class="card" style="text-align: center; padding: 40px; margin: 50px auto; max-width: 600px;">
        <h1 style="color: #1877f2; margin-bottom: 20px;">Welcome to Nepixo</h1>
        <p style="font-size: 18px; margin-bottom: 30px;">
            Connect with friends, share your thoughts, and join conversations.
        </p>
        
        <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;">
            <a href="{% url 'register' %}" class="btn" style="padding: 12px 30px; font-size: 16px;">
                Get Started
            </a>
            <a href="{% url 'login' %}" class="btn" style="padding: 12px 30px; font-size: 16px; background: #42b72a;">
                Login
            </a>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 40px;">
            <div class="feature-card">
                <div style="font-size: 40px; margin-bottom: 15px;">üí¨</div>
                <h3>Real-time Messages</h3>
                <p>Chat instantly with friends and family</p>
            </div>
            
            <div class="feature-card">
                <div style="font-size: 40px; margin-bottom: 15px;">üìù</div>
                <h3>Share Thoughts</h3>
                <p>Post your ideas and get feedback</p>
            </div>
            
            <div class="feature-card">
                <div style="font-size: 40px; margin-bottom: 15px;">üë•</div>
                <h3>Connect</h3>
                <p>Follow friends and discover new people</p>
            </div>
        </div>
    </div>
    
    <!-- Recent Public Posts -->
    <div class="card" style="margin-top: 30px;">
        <h2 style="text-align: center; margin-bottom: 20px;">Recent Public Posts</h2>
        {% for post in public_posts %}
        <div class="card post" style="margin-bottom: 15px;">
            <div class="post-header">
                <!-- Make profile picture clickable in public posts too -->
                <a href="{% url 'profile' post.user.username %}" style="text-decoration: none;">
                    <img src="{% if post.user.profile.profile_pic %}{{ post.user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/40{% endif %}" 
                         class="profile-pic" alt="{{ post.user.username }}"
                         style="cursor: pointer;">
                </a>
                <div>
                    <!-- Username link -->
                    <strong><a href="{% url 'profile' post.user.username %}" style="text-decoration: none; color: inherit;">{{ post.user.username }}</a></strong>
                    <div style="font-size: 12px; color: #65676b;">
                        {{ post.created_at|timesince }} ago
                    </div>
                </div>
            </div>
            
            <div class="post-content">
                {{ post.content|linebreaks }}
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <small style="color: #666;">
                    <a href="{% url 'login' %}">Login</a> to like, comment, and follow users
                </small>
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 20px;">
            <p>No posts yet. Be the first to join and post!</p>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .feature-card {
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        text-align: center;
        transition: transform 0.3s;
    }
    
    
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Post Action Icons Styles */
.post-actions {
    display: flex;
    gap: 15px;
    padding: 10px 15px;
    border-top: 1px solid #eee;
}
/* Share icon */
.share-icon {
    color: #65676b;
    transition: all 0.2s;
}

/* Hover effect for share button */
.post-action:hover .share-icon {
    color: #42b72a; /* Green color for share */
}
.post-action {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    color: #65676b;
    font-size: 14px;
    transition: all 0.2s;
    padding: 6px 10px;
    border-radius: 6px;
    user-select: none;
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none; /* Firefox */
    -ms-user-select: none; /* IE/Edge */
    -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
}

.post-action:hover {
    background-color: #f0f2f5;
    color: #1877f2;
}

.post-action i {
    font-size: 16px;
    transition: transform 0.2s;
}

.post-action-text {
    font-size: 13px;
    font-weight: 500;
}

.post-action-count {
    font-size: 13px;
    color: #65676b;
    min-width: 16px;
}



/* Like icon specific styles */
.like-icon {
    color: #65676b;
    transition: color 0.2s;
}

.like-icon.liked {
    color: #ed4956; /* Instagram-like red for liked state */
    animation: heartBeat 0.5s;
}

/* Comment icon */
.comment-icon {
    color: #65676b;
}

/* Message icon */
.message-icon {
    color: #65676b;
}

/* Delete icon for user's own posts */
.delete-icon {
    color: #dc3545;
}

/* Heart beat animation for like */
@keyframes heartBeat {
    0% { transform: scale(1); }
    14% { transform: scale(1.3); }
    28% { transform: scale(1); }
    42% { transform: scale(1.3); }
    70% { transform: scale(1); }
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .post-actions {
        gap: 10px;
        justify-content: space-around;
        padding: 12px 10px;
    }
    
    .post-action {
        flex-direction: column;
        gap: 4px;
        padding: 8px;
        text-align: center;
        flex: 1;
    }
    
    .post-action i {
        font-size: 18px;
    }
    
    .post-action-text {
        font-size: 11px;
        display: none; /* Hide text on very small screens */
    }
    
    .post-action-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #1877f2;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Mobile optimizations */
@media (max-width: 768px) {
    .post-actions {
        gap: 10px;
        justify-content: space-around;
        padding: 12px 10px;
    }
    
    .post-action {
        flex-direction: column;
        gap: 4px;
        padding: 8px;
        text-align: center;
        flex: 1;
    }
    
    .post-action i {
        font-size: 18px;
    }
    
    .post-action-text {
        font-size: 11px;
        display: none; /* Hide text on very small screens */
    }
    
    .post-action-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #42b72a; /* Green for share count */
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Different colors for different counts */
    #likeCount-${postId} {
        background: #ed4956; /* Red for likes */
    }
    
    #commentCount-${postId} {
        background: #1877f2; /* Blue for comments */
    }
    
    #shareCount-${postId} {
        background: #42b72a; /* Green for shares */
    }
    
    /* Show text on larger mobile screens */
    @media (min-width: 480px) {
        .post-action-text {
            display: block;
        }
        
        .post-action {
            flex-direction: row;
        }
        
        .post-action-count {
            position: static;
            background: transparent;
            color: #65676b;
            width: auto;
            height: auto;
        }
    }
}
    
    /* Show text on larger mobile screens */
    @media (min-width: 480px) {
        .post-action-text {
            display: block;
        }
        
        .post-action {
            flex-direction: row;
        }
        
        .post-action-count {
            position: static;
            background: transparent;
            color: #65676b;
            width: auto;
            height: auto;
        }
    }
}

/* Active state for better mobile feedback */
.post-action:active {
    transform: scale(0.95);
    background-color: #e4e6eb;
}
    
    .feature-card h3 {
        margin: 10px 0;
        color: #1877f2;
    }
    
    .feature-card p {
        color: #666;
        font-size: 14px;
    }
    
    /* Add hover effect for clickable profile pictures */
    .profile-pic {
        transition: transform 0.2s, opacity 0.2s;
    }
    
    .profile-pic:hover {
        transform: scale(1.05);
        opacity: 0.9;
    }

    
</style>
{% endif %}

<!-- Message Box (only for logged in users) -->
{% if user.is_authenticated %}
<div id="messageBox" class="message-box">
    <div class="message-header">
        <span id="messageHeader">Messages</span>
        <span onclick="document.getElementById('messageBox').style.display='none'" style="cursor: pointer;">√ó</span>
    </div>
    <div class="message-body" id="messageBody">
        <!-- Messages will appear here -->
    </div>
    <div class="message-input">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <input type="hidden" id="messageReceiver">
    </div>
</div>
{% endif %}

{% if user.is_authenticated %}
<script>
    // Create Post
    function createPost() {
    const content = document.getElementById('postContent').value.trim();
    
    if (content) {
        // Use the correct URL pattern from Django
        fetch('{% url "create_post" %}', {  // Fixed: Using Django URL tag
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'content=' + encodeURIComponent(content)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear the textarea
                document.getElementById('postContent').value = '';
                
                // Option 1: Reload the page to show new post
                // location.reload();
                
                // Option 2: Dynamically add the new post without reloading (better UX)
                addNewPostDynamically(content);
            } else {
                alert('Failed to create post. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating post. Please try again.');
        });
    } else {
        alert('Please write something before posting!');
    }
}
// Function to add new post dynamically without reloading
// Function to add new post dynamically without reloading
function addNewPostDynamically(content) {
    const postsContainer = document.getElementById('postsContainer');
    const currentUser = '{{ user.username }}';
    const currentUserPic = '{% if user.profile.profile_pic %}{{ user.profile.profile_pic.url }}{% else %}https://via.placeholder.com/40{% endif %}';
    
    // Get current timestamp
    const now = new Date();
    const timeString = 'Just now';
    
    const postHTML = `
        <div class="card post" style="animation: fadeIn 0.5s;">
            <div class="post-header">
                <a href="{% url 'profile' user.username %}" style="text-decoration: none;">
                    <img src="${currentUserPic}" 
                         class="profile-pic" alt="${currentUser}"
                         style="cursor: pointer;">
                </a>
                <div>
                    <strong><a href="{% url 'profile' user.username %}" style="text-decoration: none; color: inherit;">${currentUser}</a></strong>
                    <div style="font-size: 12px; color: #65676b;">
                        ${timeString}
                    </div>
                </div>
            </div>
            
            <div class="post-content">
                ${content.replace(/\n/g, '<br>')}
            </div>
            
            <div class="post-actions">
                <span class="post-action" onclick="likePost('new')">
                    <i id="likeIcon-new" class="like-icon far fa-heart"></i>
                    <span id="likeText-new">Like</span>
                    <span class="post-action-count" id="likeCount-new" style="display: none;">0</span>
                </span>
                
                <span class="post-action" onclick="toggleComment('new')">
                    <i class="far fa-comment comment-icon"></i>
                    <span>Comment</span>
                    <span class="post-action-count" id="commentCount-new" style="display: none;">0</span>
                </span>
                
                <span class="post-action" onclick="sharePost('new')">
                    <i class="far fa-share-square share-icon"></i>
                    <span>Share</span>
                    <span class="post-action-count" id="shareCount-new" style="display: none;">0</span>
                </span>
            </div>
            
            <!-- Comments Section -->
            <div id="comments-new" style="display: none; margin-top: 15px;">
                <div class="form-group">
                    <input type="text" id="commentInput-new" class="form-control" placeholder="Write a comment..." 
                           onkeypress="if(event.key === 'Enter') addComment('new')">
                </div>
                <div id="commentList-new">
                    <!-- Comments will be loaded here -->
                </div>
            </div>
        </div>
    `;
    
    // Insert at the top of posts container
    postsContainer.insertAdjacentHTML('afterbegin', postHTML);
    
    // Add fade-in animation
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
}


// Share Post Function
function sharePost(postId) {
    // Get the post element
    const postElement = document.getElementById('post-' + postId);
    
    // Create share options modal
    const shareModal = document.createElement('div');
    shareModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    // Get post content
    const postContent = postElement.querySelector('.post-content').innerText;
    const postUser = postElement.querySelector('.post-header strong a').innerText;
    const shareUrl = window.location.origin + '/post/' + postId + '/';
    
    shareModal.innerHTML = `
    <div style="background: white; border-radius: 12px; padding: 20px; width: 90%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; color: #1877f2; font-size: 18px;">Share this post</h3>
            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #65676b; line-height: 1;">
                √ó
            </button>
        </div>
        
        <!-- Share Options -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
            <button onclick="copyToClipboard('${shareUrl}')" 
                    class="share-option-btn" title="Copy Link">
                <i class="fas fa-link" style="font-size: 20px;"></i>
                <span style="font-size: 11px;">Copy Link</span>
            </button>
            
            <button onclick="shareToWhatsApp('${shareUrl}', '${postContent.substring(0, 100)}...')" 
                    class="share-option-btn" title="WhatsApp">
                <i class="fab fa-whatsapp" style="color: #25D366; font-size: 20px;"></i>
                <span style="font-size: 11px;">WhatsApp</span>
            </button>
            
            <button onclick="shareViaEmail('${shareUrl}', '${postContent}', '${postUser}')" 
                    class="share-option-btn" title="Email">
                <i class="fas fa-envelope" style="color: #EA4335; font-size: 20px;"></i>
                <span style="font-size: 11px;">Email</span>
            </button>
            
        </div>
        
        <!-- Quick Share Preview -->
        <div style="background: #f0f2f5; padding: 10px; border-radius: 8px; margin-top: 12px; font-size: 13px;">
            <div style="color: #65676b; margin-bottom: 6px; font-size: 12px;">Preview:</div>
            <div style="font-weight: 500; margin-bottom: 4px; color: #050505;">${postUser}</div>
            <div style="color: #65676b; word-break: break-all; font-size: 11px; margin-top: 4px;">${shareUrl}</div>
        </div>
    </div>
`;
    
    document.body.appendChild(shareModal);
    
    // Add CSS for share buttons
    const shareStyle = document.createElement('style');
    shareStyle.innerHTML = `
        .share-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            gap: 8px;
        }
        
        .share-option-btn:hover {
            background: #f0f2f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .share-option-btn i {
            font-size: 24px;
        }
        
        .share-option-btn span {
            font-size: 12px;
            color: #65676b;
        }
    `;
    document.head.appendChild(shareStyle);
}

// Share Helper Functions



function shareToWhatsApp(url, text) {
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
    window.open(whatsappUrl, '_blank');
}

function shareToFacebook(url) {
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    window.open(facebookUrl, '_blank', 'width=600,height=400');
}

function shareToTwitter(url, text) {
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
    window.open(twitterUrl, '_blank', 'width=600,height=400');
}

function shareViaEmail(url, content, user) {
    const subject = `Check out this post by ${user} on SocialApp`;
    const body = `${user} posted on SocialApp:\n\n${content}\n\nView it here: ${url}`;
    const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoUrl;
}

function shareAsNewPost(postId) {
    // Get post content
    const postElement = document.getElementById('post-' + postId);
    const postContent = postElement.querySelector('.post-content').innerText;
    const postUser = postElement.querySelector('.post-header strong a').innerText;
    
    // Set the quote in the post creation textarea
    const quote = `"${postContent}"\n\n- Shared from ${postUser}`;
    document.getElementById('postContent').value = quote;
    document.getElementById('postContent').focus();
    
    // Close share modal
    document.querySelector('[style*="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5)"]')?.remove();
    
    // Increment share count (you would need backend support for this)
    updateShareCount(postId);
}

function updateShareCount(postId) {
    // This would typically call your backend API to increment share count
    // For now, we'll just update the UI
    const shareCount = document.getElementById('shareCount-' + postId);
    if (shareCount) {
        const currentCount = parseInt(shareCount.textContent) || 0;
        shareCount.textContent = currentCount + 1;
        shareCount.style.display = 'inline';
        
        // Add animation
        shareCount.style.transform = 'scale(1.3)';
        setTimeout(() => {
            shareCount.style.transform = 'scale(1)';
        }, 200);
    }
}
    
    // Like Post
   function likePost(postId) {
    const likeIcon = document.getElementById('likeIcon-' + postId);
    const likeText = document.getElementById('likeText-' + postId);
    const likeCount = document.getElementById('likeCount-' + postId);
    
    // Add loading state
    likeIcon.style.opacity = '0.7';
    
    fetch('/like/' + postId + '/')
        .then(response => response.json())
        .then(data => {
            if (data.liked) {
                // Change to filled heart
                likeIcon.className = 'like-icon fas fa-heart liked';
                likeText.textContent = 'Liked';
                
                // Add animation
                likeIcon.style.animation = 'heartBeat 0.5s';
                setTimeout(() => {
                    likeIcon.style.animation = '';
                }, 500);
            } else {
                // Change to outline heart
                likeIcon.className = 'like-icon far fa-heart';
                likeText.textContent = 'Like';
            }
            
            // Update count
            if (likeCount) {
                if (data.count > 0) {
                    likeCount.textContent = data.count;
                    likeCount.style.display = 'inline';
                    
                    // Add count animation
                    likeCount.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        likeCount.style.transform = 'scale(1)';
                    }, 200);
                } else {
                    likeCount.style.display = 'none';
                }
            }
            
            // Remove loading state
            likeIcon.style.opacity = '1';
        })
        .catch(error => {
            console.error('Error liking post:', error);
            likeIcon.style.opacity = '1';
        });
}
    
    // Toggle Comments
    function toggleComment(postId) {
        const commentSection = document.getElementById('comments-' + postId);
        if (commentSection.style.display === 'none') {
            commentSection.style.display = 'block';
            loadComments(postId);
        } else {
            commentSection.style.display = 'none';
        }
    }
    
    // Add Comment
    function addComment(postId) {
        const input = document.getElementById('commentInput-' + postId);
        const content = input.value.trim();
        
        if (content) {
            fetch('/comment/' + postId + '/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'content=' + encodeURIComponent(content)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    // Add new comment to the list
                    addCommentToUI(postId, data.comment);
                    // Update comment count if displayed
                    updateCommentCount(postId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding comment. Please try again.');
            });
        }
    }
    // Initialize comment functionality for mobile
document.addEventListener('DOMContentLoaded', function() {
    // Set up all comment inputs
    const commentInputs = document.querySelectorAll('[id^="commentInput-"]');
    commentInputs.forEach(input => {
        const postId = input.id.split('-')[1];
        const commentBtn = document.getElementById('commentBtn-' + postId);
        
        if (commentBtn) {
            // Update button state based on input
            input.addEventListener('input', function() {
                const hasContent = this.value.trim().length > 0;
                commentBtn.disabled = !hasContent;
                commentBtn.style.opacity = hasContent ? '1' : '0.5';
                commentBtn.style.cursor = hasContent ? 'pointer' : 'not-allowed';
            });
            
            // Initialize button state
            commentBtn.disabled = input.value.trim().length === 0;
            commentBtn.style.opacity = commentBtn.disabled ? '0.5' : '1';
            commentBtn.style.cursor = commentBtn.disabled ? 'not-allowed' : 'pointer';
            
            // Add touch feedback for mobile
            commentBtn.addEventListener('touchstart', function() {
                if (!this.disabled) {
                    this.style.transform = 'translateY(-50%) scale(0.95)';
                }
            });
            
            commentBtn.addEventListener('touchend', function() {
                this.style.transform = 'translateY(-50%)';
            });
        }
        
        // Better mobile keyboard handling
        input.addEventListener('keydown', function(e) {
            // Handle mobile keyboard's "go" or "send" button
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addComment(postId);
            }
        });
    });
    
    // Check if device is mobile
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Show mobile hints on mobile devices
    if (isMobileDevice()) {
        const mobileHints = document.querySelectorAll('[id^="mobileHint-"]');
        mobileHints.forEach(hint => {
            hint.style.display = 'block';
        });
    }
});

// Enhanced addComment function with mobile feedback
function addComment(postId) {
    const input = document.getElementById('commentInput-' + postId);
    const button = document.getElementById('commentBtn-' + postId);
    const content = input.value.trim();
    
    if (content && !button.disabled) {
        // Add loading state
        const originalHTML = button.innerHTML;
        button.innerHTML = '<span style="font-size: 12px;">...</span>';
        button.disabled = true;
        button.style.cursor = 'wait';
        
        fetch('/comment/' + postId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'content=' + encodeURIComponent(content)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear input
                input.value = '';
                
                // Reset button
                button.innerHTML = originalHTML;
                button.disabled = false;
                button.style.cursor = 'pointer';
                button.style.opacity = '0.5';
                
                // Add new comment to the list
                addCommentToUI(postId, data.comment);
                
                // Update comment count
                updateCommentCount(postId);
                
                // Show success feedback (subtle)
                input.placeholder = 'Comment added!';
                setTimeout(() => {
                    input.placeholder = 'Write another comment...';
                }, 1500);
            } else {
                alert('Failed to add comment. Please try again.');
                button.innerHTML = originalHTML;
                button.disabled = false;
                button.style.cursor = 'pointer';
                button.style.opacity = '1';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding comment. Please check your connection.');
            button.innerHTML = originalHTML;
            button.disabled = false;
            button.style.cursor = 'pointer';
            button.style.opacity = '1';
        });
    } else if (!content) {
        // Shake animation for empty comment
        input.style.animation = 'shake 0.5s';
        input.focus();
        setTimeout(() => {
            input.style.animation = '';
        }, 500);
    }
}

// Add shake animation to CSS
const style = document.createElement('style');
style.innerHTML = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
`;
document.head.appendChild(style);
    // Load Comments
    function loadComments(postId) {
        const commentList = document.getElementById('commentList-' + postId);
        commentList.innerHTML = '<p>Loading comments...</p>';
        
        fetch('/get-comments/' + postId + '/')
            .then(response => response.json())
            .then(data => {
                commentList.innerHTML = '';
                
                if (data.comments.length === 0) {
                    commentList.innerHTML = '<p style="color: #666; text-align: center;">No comments yet. Be the first to comment!</p>';
                    return;
                }
                
                data.comments.forEach(comment => {
                    addCommentToUI(postId, comment, false);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                commentList.innerHTML = '<p style="color: red;">Error loading comments</p>';
            });
    }
    
    // Add Comment to UI// Add Comment to UI
function addCommentToUI(postId, comment, scrollToBottom = true) {
    const commentList = document.getElementById('commentList-' + postId);
    
    const commentDiv = document.createElement('div');
    commentDiv.className = 'comment-item';
    commentDiv.style.cssText = `
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    `;
    
    // Use the actual profile picture from the comment data
    const profilePic = comment.profile_pic || 'https://via.placeholder.com/30';
    
    commentDiv.innerHTML = `
        <a href="/profile/${comment.user}/" style="text-decoration: none;">
            <img src="${profilePic}" 
                 style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;"
                 alt="${comment.user}"
                 onerror="this.src='https://via.placeholder.com/30'">
        </a>
        <div style="flex: 1;">
            <div style="display: flex; justify-content: space-between;">
                <a href="/profile/${comment.user}/" style="text-decoration: none; color: #1877f2; font-weight: bold; font-size: 14px;">
                    ${comment.user}
                </a>
                <small style="color: #666; font-size: 12px;">${comment.created_at}</small>
            </div>
            <p style="margin: 5px 0 0 0; font-size: 14px;">${comment.content}</p>
        </div>
    `;
    
    commentList.appendChild(commentDiv);
    
    if (scrollToBottom) {
        commentList.scrollTop = commentList.scrollHeight;
    }
}
    // Update comment count (if you want to show comment count)
  // Also update the comment count updating function
function updateCommentCount(postId) {
    const commentCount = document.getElementById('commentCount-' + postId);
    if (commentCount) {
        fetch('/get-comments/' + postId + '/')
            .then(response => response.json())
            .then(data => {
                if (data.comments.length > 0) {
                    commentCount.textContent = data.comments.length;
                    commentCount.style.display = 'inline';
                } else {
                    commentCount.style.display = 'none';
                }
            });
    }
}
    
    // Follow User
    function followUser(username) {
        fetch('/follow/' + username + '/')
            .then(response => response.json())
            .then(data => {
                if (data.followed) {
                    // alert('You are now following ' + username);
                } else {
                    // alert('Unfollowed ' + username);
                }
                location.reload();
            });
    }
    
    // Enable Enter key for post creation
    document.addEventListener('DOMContentLoaded', function() {
        const postInput = document.getElementById('postContent');
        if (postInput) {
            postInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    createPost();
                }
            });
        }
    });
</script>
{% endif %}
{% endblock %}